<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../core-input/core-input.html">


<!--
Converts an array of object to data suitable for thelma charts.

##### Example

    <th-chart-data-filter></th-chart-data-filter>

@element th-chart-data-filter
@blurb Converts an array of object to data suitable for thelma charts.
@status alpha
@homepage http://thelmanews.github.io/thelma-components
-->
<polymer-element name="th-chart-data-filter" attributes="dataInput chartDataOut autoFlush">

  <template>
      <style>
        :host {
          width: 200px;
        }

      </style>

      <core-selector id="colums_selector" selected="{{_selectedLabel}}" valueattr="label">
        <template repeat="{{attr in _dataAttributes}}">
          <div label="{{attr}}">{{attr}}</div>
        </template>
      </core-selector>

      <core-input value="{{labelPrefix}}" placeHolder="prefix for label"></core-input>
      <core-input value="{{numberOfRows}}" placeHolder="Number of Rows"></core-input>


      <core-selector id="colums_selector" selected="{{_selectedValue}}" valueattr="label">
        <template repeat="{{attr in _dataAttributes}}">
          <div label="{{attr}}">{{attr}}</div>
        </template>
      </core-selector>

  </template>

  <script>

    Polymer('th-chart-data-filter', {
      /**
       * Input data from data source
       * @type {Array}
       */
      dataInput: null,
      
      /**
       * Data suitable for thelma charts
       * @type {Array}
       */
      chartDataOut: [],

      /**
       * Automatically flush data to chartDataOut when dataInput changes
       * @type {Boolean}
       */
      autoFlush: false,

      /**
       * Number of rows (dataPoints) to pass to the chart
       * @type {Number}
       */
      numberOfRows: 52,

      /**
       * Attributes in each dataInput Object
       * @type {Array}
       */
      _dataAttributes: [],


      _labelPrefix: '',


      ready: function() {


      },

      dataInputChanged: function() {

          var self = this;
          var firstItem = self.dataInput[0];
          if(!firstItem) {
            return;
          }
          var attributes = Object.keys(firstItem);
          
          if(JSON.stringify(self._dataAttributes) === JSON.stringify(attributes) ) {
            //self._mapChartData();
          }
          else {
            self._dataAttributes = attributes;
            var firstKeyValue = parseFloat(firstItem[attributes[1]]);
            console.log(firstKeyValue);
            if(firstKeyValue) {
              self._selectedLabel = attributes[0];
              self._selectedValue = attributes[1];
            }
          }

          self._mapChartData();


        

      },

      _labelPrefixChanged: function() {
        this._mapChartData();
      },

      _mapChartData: function() {

          var self = this;
          var tmp = self.dataInput;
          tmp = tmp.slice(0, self.numberOfRows);
          if(tmp.lenght==0) {
            return;
          }
          var ret = tmp.map(function(item) {

              return {label: self._labelPrefix+ " "+ item[self._selectedLabel] , value: parseFloat(item[self._selectedValue]), display_value: item[self._selectedValue]  };
          });
          console.log(ret);
          self.chartDataOut = ret;

      }



    });

  </script>

</polymer-element>
